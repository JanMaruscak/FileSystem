@page "/fs/{Disk?}/{Location?}"

@using FileSystem.Models
@using FileSystem.Data
@using MongoDB.Bson
@inject NavigationManager NavigationManager
@inject FileSystemService FileSystemService

<h3>Disk://@Location</h3>
@if (_files == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Name</th>
            <th>Created</th>
            <th>Last Edit</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var file in _files)
        {
            <tr>
                <td>File</td>
                <td>@file.Name</td>
                <td>@file.Created</td>
                <td>@file.LastEdit</td>
            </tr>
        }
        @foreach (var folder in _folders)
        {
            <tr>
                <td @onclick="@(e => MethodToTriggerUrl(folder.Name))">Folder</td>
                <td>@folder.Name</td>
                <td>@folder.Created</td>
                <td>@folder.LastEdit</td>
            </tr>
        }
        </tbody>
    </table>
    
    <select @bind=_newInsertType>
        <option value="folder">Folder</option>
        <option value="file">File</option>
    </select>
    @switch (_newInsertType)
    {
        case "folder":
            <input type="text" @bind="_newFolderName"/>
            <button @onclick="InsertFolder">Add @_newInsertType</button>
            break;
        case "file":
            <input type="text" @bind="_newFileName"/>
            <button @onclick="InsertFile">Add @_newInsertType</button>
            break;
    }

@code {
    [Parameter]
    public string Location { get; set; }
[Parameter]
    public string Disk { get; set; }

    private Folder _current;

    private string _newInsertType = "file";
    private string _newFileName;
    private string _newFolderName;
    
    private List<File> _files;
    private List<Folder> _folders;

    protected override async Task OnInitializedAsync()
    {
        _current = FileSystemService.GetFolderByLocation(Location);
        _files = await FileSystemService.GetFilesAsync(_current.Id, FileSystemService.ParentType.Folder);
        _folders = await FileSystemService.GetFoldersAsync(_current.Id, FileSystemService.ParentType.Folder);

    // _files = await FileSystemService.GetFilesAsync(FileSystemService.GetDisksAsync().Result.First(t => t.Name == Location).Id);
    }
    public async void InsertFile()
    {
        var newFile = new File
        {
            Content = "",
            Created = DateTime.Now,
            Id =  ObjectId.GenerateNewId(),
            LastEdit = DateTime.Now,
            Name = _newFileName,
            Parent = FileSystemService.GetFolderByLocation(Location).Id
        };
        await FileSystemService.InsertFileAsync(newFile);
        _files.Add(newFile);
        StateHasChanged();
    }
    public async void InsertFolder()
    {
        var newFolder = new Folder
        {
            Created = DateTime.Now,
            Id =  ObjectId.GenerateNewId(),
            LastEdit = DateTime.Now,
            Name = _newFolderName,
            Parent = FileSystemService.GetFolderByLocation(Location).Id,
            Files = new List<ObjectId>(),
            Subfolders = new List<ObjectId>(),
            TotalSize = 0
        };
        await FileSystemService.InsertFolderAsync(newFolder);
        _folders.Add(newFolder);
        StateHasChanged();
    }
    void MethodToTriggerUrl(string folder)
    {
        NavigationManager.NavigateTo($"fs/{Disk}/{Location}/{folder}");
    }

}}